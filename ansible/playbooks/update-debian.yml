---
- hosts: [NODE, LXC, VM]
  become: true
  gather_facts: true
  name: Update Systems
  tasks:
      #Debian Linux
    - name: Perform a dist-upgrade.
      ansible.builtin.apt:
        upgrade: dist
        update_cache: yes

    - name: Check if a reboot is required.
      ansible.builtin.stat:
        path: /var/run/reboot-required
        get_checksum: no
      register: reboot_required_file

    - name: Reboot the server (if required).
      ansible.builtin.reboot:
      when: reboot_required_file.stat.exists == true

    - name: Remove dependencies that are no longer required.
      ansible.builtin.apt:
        autoremove: yes

    #Alpine Linux
    - name: Update
      command: /sbin/apk update
      when: ansible_os_family == "Alpine"
    - name: Upgrade
      command: /sbin/apk upgrade -U -a
      when: ansible_os_family == "Alpine"
    - name: Clean cache
      command: /sbin/apk cache clean
      when: ansible_os_family == "Alpine"